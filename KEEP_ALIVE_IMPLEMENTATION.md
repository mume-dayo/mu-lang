# Discord Bot å¸¸æ™‚ç›£è¦–ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã®å®Ÿè£…

## æ¦‚è¦

mm_discord.pyã® `bot.run()` ã¨åŒã˜å‹•ä½œã‚’Rustç‰ˆã§å®Ÿç¾ã™ã‚‹ãŸã‚ã€**å¸¸æ™‚ç›£è¦–ãƒ«ãƒ¼ãƒ—ï¼ˆKeep-Aliveï¼‰**ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

## å®Ÿè£…å‰ã®å•é¡Œ

### å•é¡Œç‚¹

```mumei
# å¤ã„å®Ÿè£…
d.run(token, 32767);  # Gatewayã«æ¥ç¶š

# ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒã“ã“ã§çµ‚äº†ï¼
# Gatewayã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‹•ã„ã¦ã„ã‚‹ãŒã€ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ãŒçµ‚ã‚ã‚‹ã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ å…¨ä½“ãŒçµ‚äº†
```

**ãªãœå•é¡Œã ã£ãŸã‹:**
- `gateway_connect()` ã¯ `tokio::spawn()` ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯ã¨ã—ã¦èµ·å‹•
- ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã™ãã«çµ‚äº†ã—ã¦ã—ã¾ã†
- BotãŒå‹•ä½œã™ã‚‹å‰ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒçµ‚ã‚ã‚‹

## å®Ÿè£…æ–¹æ³•

### Rustå´ã®å®Ÿè£…ï¼ˆgateway.rsï¼‰

```rust
// gateway.rs - line 192-209
#[pyfunction]
pub fn gateway_connect(token: String, intents: u32) -> PyResult<()> {
    // Save token for later use
    {
        let mut client = GATEWAY_CLIENT.lock().unwrap();
        *client = Some(token.clone());
    }

    // Start gateway in background
    tokio::spawn(async move {
        let mut gateway = Gateway::new(token, intents);
        if let Err(e) = gateway.connect().await {
            eprintln!("Gateway error: {}", e);
        }
    });

    Ok(())
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**
- `tokio::spawn()` ã§éåŒæœŸã‚¿ã‚¹ã‚¯ã‚’èµ·å‹•
- ã‚¿ã‚¹ã‚¯ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‹•ä½œ
- ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ã™ãã«æˆ»ã‚‹

### Mumeiå´ã®å®Ÿè£…ï¼ˆd_rust_full.muï¼‰

#### Beforeï¼ˆå•é¡Œã‚ã‚Šï¼‰

```mumei
fun run(token, intents) {
    gateway_connect(token, intents);
    print("âœ… Gateway connected!");
    # ã“ã“ã§é–¢æ•°ãŒçµ‚äº†ã—ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚‚çµ‚äº†
}
```

#### Afterï¼ˆæ”¹å–„ç‰ˆï¼‰

```mumei
fun run(token, intents) {
    gateway_connect(token, intents);

    print("âœ… Gateway connected!");
    print("ğŸ”„ Bot is running... (Press Ctrl+C to stop)");

    # mm_discord.pyã®bot.run()ã¨åŒã˜ã‚ˆã†ã«å¸¸æ™‚ç›£è¦–
    _keep_alive();  # â† ç„¡é™ãƒ«ãƒ¼ãƒ—ã§ãƒ–ãƒ­ãƒƒã‚¯
}

fun _keep_alive() {
    print("ğŸ’¤ Entering event loop (keeping bot alive)...");

    # ç„¡é™ãƒ«ãƒ¼ãƒ—ã§Botã‚’ç¨¼åƒã—ç¶šã‘ã‚‹
    # mm_discord.pyã®_bot.run()ã‚‚å†…éƒ¨çš„ã«asyncioã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’å›ã—ã¦ã„ã‚‹
    while (True) {
        sleep(1);  # 1ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ï¼ˆCPUè² è·ã‚’æŠ‘ãˆã‚‹ï¼‰
    }
}
```

## mm_discord.pyã¨ã®æ¯”è¼ƒ

### Pythonç‰ˆã®å†…éƒ¨å‹•ä½œ

```python
# mm_discord.py
def discord_run(token):
    _bot.run(token)  # â† ã“ã“ã§ãƒ–ãƒ­ãƒƒã‚¯

# discord.pyã®å†…éƒ¨
class Bot:
    def run(self, token):
        asyncio.run(self.start(token))  # â† asyncioã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—é–‹å§‹
        # â†‘ ã“ã“ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã€Ctrl+Cã¾ã§æˆ»ã‚‰ãªã„
```

**discord.pyã® `bot.run()` ã®å‹•ä½œ:**
1. `asyncio.run()` ã‚’å‘¼ã³å‡ºã™
2. ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
3. WebSocketæ¥ç¶šã‚’ç¢ºç«‹
4. ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…æ©Ÿã—ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œ
5. **Ctrl+CãŒæŠ¼ã•ã‚Œã‚‹ã¾ã§ãƒ–ãƒ­ãƒƒã‚¯**

### Rustç‰ˆã®å‹•ä½œ

```mumei
# d_rust_full.mu
d.run(token, 32767);  # â† ã“ã“ã§ãƒ–ãƒ­ãƒƒã‚¯

# å†…éƒ¨å‹•ä½œ
fun run(token, intents) {
    gateway_connect(token, intents);  # WebSocketæ¥ç¶šï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
    _keep_alive();  # â† while (True) { sleep(1); }
    # â†‘ ã“ã“ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã€Ctrl+Cã¾ã§æˆ»ã‚‰ãªã„
}
```

**d_rust_full.muã®å‹•ä½œ:**
1. `gateway_connect()` ã§WebSocketæ¥ç¶šï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
2. `_keep_alive()` ã§ç„¡é™ãƒ«ãƒ¼ãƒ—é–‹å§‹
3. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ãƒ»å‡¦ç†
4. **Ctrl+CãŒæŠ¼ã•ã‚Œã‚‹ã¾ã§ãƒ–ãƒ­ãƒƒã‚¯**

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Main Thread (Mumei)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ d.run(token, intents)             â”‚  â”‚
â”‚  â”‚   â†“                               â”‚  â”‚
â”‚  â”‚ gateway_connect()                 â”‚  â”‚
â”‚  â”‚   â†“                               â”‚  â”‚
â”‚  â”‚ _keep_alive()                     â”‚  â”‚
â”‚  â”‚   â†“                               â”‚  â”‚
â”‚  â”‚ while (True) { sleep(1); }        â”‚  â”‚
â”‚  â”‚   â†‘ ãƒ«ãƒ¼ãƒ—ã—ç¶šã‘ã‚‹                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Background Thread (Tokio)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ tokio::spawn(async {              â”‚  â”‚
â”‚  â”‚   Gateway::connect().await        â”‚  â”‚
â”‚  â”‚   â†“                               â”‚  â”‚
â”‚  â”‚   WebSocketæ¥ç¶š                    â”‚  â”‚
â”‚  â”‚   â†“                               â”‚  â”‚
â”‚  â”‚   while let Some(msg) = read() {  â”‚  â”‚
â”‚  â”‚     handle_message(msg);          â”‚  â”‚
â”‚  â”‚     trigger_callbacks();          â”‚  â”‚
â”‚  â”‚   }                               â”‚  â”‚
â”‚  â”‚ })                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å½¹å‰²åˆ†æ‹…:**
- **Main Thread**: ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ç¶­æŒï¼ˆ`while (True)`ãƒ«ãƒ¼ãƒ—ï¼‰
- **Background Thread**: WebSocketæ¥ç¶šãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†

## CPUè² è·ã®æœ€é©åŒ–

### ãªãœ `sleep(1)` ã‚’å…¥ã‚Œã‚‹ã‹ï¼Ÿ

```mumei
while (True) {
    sleep(1);  # â† ã“ã‚ŒãŒãªã„ã¨CPU 100%ä½¿ç”¨ï¼
}
```

**ç†ç”±:**
- `while (True) {}` ã ã‘ã ã¨CPUã‚’100%ä½¿ã„åˆ‡ã‚‹
- `sleep(1)` ã§1ç§’å¾…æ©Ÿã™ã‚‹ã“ã¨ã§ã€CPUä½¿ç”¨ç‡ã‚’å¤§å¹…ã«å‰Šæ¸›
- ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã‚ã‚Œã‚‹ãŸã‚ã€ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã¯å¾…æ©Ÿã ã‘ã§OK

**CPUä½¿ç”¨ç‡:**
- `while (True) {}` ã®ã¿: **100%**
- `while (True) { sleep(1); }`: **< 1%**

## ä½¿ç”¨ä¾‹

### ã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹

```mumei
import "d_rust_full.mu" as d;

d.create_bot("!");

d.on_ready(lambda() {
    print("Botèµ·å‹•ï¼");
});

# ã“ã®1è¡Œã ã‘ã§å¸¸æ™‚ç›£è¦–ãŒå§‹ã¾ã‚‹
d.run(env("DISCORD_TOKEN"), 32767);

# â†‘ ã“ã“ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ãŸã‚ã€ä»¥é™ã®ã‚³ãƒ¼ãƒ‰ã¯å®Ÿè¡Œã•ã‚Œãªã„
print("ã“ã‚Œã¯å®Ÿè¡Œã•ã‚Œãªã„");
```

### Pythonç‰ˆã¨ã®äº’æ›æ€§

```python
# Pythonç‰ˆï¼ˆdiscord.pyï¼‰
import discord
from discord.ext import commands

bot = commands.Bot(command_prefix="!", intents=discord.Intents.default())

@bot.event
async def on_ready():
    print("Botèµ·å‹•ï¼")

bot.run(token)  # â† ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°
print("ã“ã‚Œã¯å®Ÿè¡Œã•ã‚Œãªã„")
```

```mumei
# Rustç‰ˆï¼ˆd_rust_full.muï¼‰
import "d_rust_full.mu" as d;

d.create_bot("!");

d.on_ready(lambda() {
    print("Botèµ·å‹•ï¼");
});

d.run(token, 32767);  # â† ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°
print("ã“ã‚Œã¯å®Ÿè¡Œã•ã‚Œãªã„");
```

**å®Œå…¨ã«åŒã˜å‹•ä½œï¼**

## ã¾ã¨ã‚

### å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ

1. **`_keep_alive()` é–¢æ•°ã‚’è¿½åŠ **
   - ç„¡é™ãƒ«ãƒ¼ãƒ—ã§ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç¶­æŒ
   - `sleep(1)` ã§CPUè² è·ã‚’æŠ‘åˆ¶

2. **`d.run()` å†…ã§ `_keep_alive()` ã‚’å‘¼ã³å‡ºã™**
   - mm_discord.pyã® `bot.run()` ã¨åŒã˜ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°å‹•ä½œ
   - ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒçµ‚äº†ã—ãªã„

3. **Gatewayã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‹•ä½œ**
   - `tokio::spawn()` ã§åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
   - ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ãƒ»å‡¦ç†ã¯ä¸¦è¡Œã—ã¦è¡Œã‚ã‚Œã‚‹

### åˆ©ç‚¹

âœ… **mm_discord.pyã¨å®Œå…¨äº’æ›**
âœ… **ã‚·ãƒ³ãƒ—ãƒ«ãªä½¿ã„æ–¹**ï¼ˆ`d.run()` ã ã‘ã§OKï¼‰
âœ… **ä½CPUä½¿ç”¨ç‡**ï¼ˆ< 1%ï¼‰
âœ… **ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰å¯¾å¿œ**
âœ… **Ctrl+Cã§æ­£å¸¸çµ‚äº†**

### æ”¹å–„å‰å¾Œã®æ¯”è¼ƒ

| é …ç›® | Before | After |
|------|--------|-------|
| ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å‹•ä½œ | ã™ãçµ‚äº† | å¸¸æ™‚ç¨¼åƒ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¼ãƒ‰ | `while (True)` ãŒå¿…è¦ | ä¸è¦ |
| mm_discord.pyäº’æ› | âŒ | âœ… |
| CPUä½¿ç”¨ç‡ | N/A | < 1% |

ã“ã‚Œã§ã€**d_rust_full.mu** ã¯ **mm_discord.py** ã¨å…¨ãåŒã˜ä½¿ã„å‹æ‰‹ã«ãªã‚Šã¾ã—ãŸï¼ğŸ‰
